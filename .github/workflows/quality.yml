name: Quality Checks

on:
  pull_request:
    branches: ['**']
  push:
    branches: [main]

jobs:
  e2e_tests:
    name: Playwright Tests (${{ matrix.project }}, shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
    timeout-minutes: 120
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        project: [chromium, safari]
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]

    services:
      backend:
        image: ghcr.io/ydb-platform/local-ydb:nightly
        ports:
          - 2135:2135
          - 8765:8765
        options: --hostname localhost -e YDB_ALLOW_ORIGIN="http://localhost:3000"

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright deps
        run: npm run test:e2e:install

      - name: Run Playwright tests
        id: run_tests
        run: npm run test:e2e -- --project=${{ matrix.project }} --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
        env:
          CI: true
          PLAYWRIGHT_VIDEO: 'on'

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts-${{ matrix.project }}-${{ matrix.shardIndex }}
          path: playwright-artifacts
          retention-days: 5

      - name: Get test results
        if: always()
        id: test-results
        run: |
          echo "Current directory: $(pwd)"
          echo "Listing playwright-artifacts directory:"
          ls -R playwright-artifacts

          if [ -f "playwright-artifacts/test-results.json" ]; then          
            echo "Parsing JSON file:"
            total=$(jq '.stats.expected + .stats.unexpected + .stats.flaky + .stats.skipped' playwright-artifacts/test-results.json)
            passed=$(jq '.stats.expected' playwright-artifacts/test-results.json)
            failed=$(jq '.stats.unexpected' playwright-artifacts/test-results.json)
            flaky=$(jq '.stats.flaky' playwright-artifacts/test-results.json)
            skipped=$(jq '.stats.skipped' playwright-artifacts/test-results.json)

            echo "Parsed values:"
            echo "Total: $total"
            echo "Passed: $passed"
            echo "Failed: $failed"
            echo "Flaky: $flaky"
            echo "Skipped: $skipped"
          else
            echo "test-results.json file not found"
            total=0
            passed=0
            failed=0
            flaky=0
            skipped=0
          fi

          echo "total=$total" >> $GITHUB_OUTPUT
          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "flaky=$flaky" >> $GITHUB_OUTPUT
          echo "skipped=$skipped" >> $GITHUB_OUTPUT

  bundle_size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      current_size: ${{ steps.current_size.outputs.size }}
      main_size: ${{ steps.main_size.outputs.size }}
      diff: ${{ steps.size_diff.outputs.diff }}
      percent: ${{ steps.size_diff.outputs.percent }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build bundle (current branch)
        run: npm run build

      - name: Get current bundle size
        id: current_size
        run: |
          size=$(du -sb build | cut -f1)
          echo "size=$size" >> $GITHUB_OUTPUT

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install dependencies (main)
        run: npm ci

      - name: Build bundle (main branch)
        run: npm run build

      - name: Get main bundle size
        id: main_size
        run: |
          size=$(du -sb build | cut -f1)
          echo "size=$size" >> $GITHUB_OUTPUT

      - name: Calculate size difference
        id: size_diff
        run: |
          current=${{ steps.current_size.outputs.size }}
          main=${{ steps.main_size.outputs.size }}
          diff=$((current - main))
          if [ "$main" -ne "0" ]; then
            percent=$(awk "BEGIN {printf \"%.2f\", ($diff/$main) * 100}")
          else
            percent="N/A"
          fi
          echo "diff=$diff" >> $GITHUB_OUTPUT
          echo "percent=$percent" >> $GITHUB_OUTPUT

  deploy_report:
    name: Deploy Test Report
    needs: [e2e_tests]
    if: always() && (github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    concurrency:
      group: deploy_report
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages
          mkdir gh-pages
          git --work-tree=gh-pages checkout gh-pages -- .

      - name: Download Playwright artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-artifacts-*
          path: playwright-artifacts-shards

      - name: Copy new report
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            REPORT_DIR="${{ github.event.pull_request.number }}"
          else
            REPORT_DIR="main"
          fi
          rm -rf gh-pages/$REPORT_DIR
          mkdir -p gh-pages/$REPORT_DIR

          # Publish per-shard HTML reports under subfolders and create an index page.
          INDEX_FILE="gh-pages/$REPORT_DIR/index.html"
          cat > "$INDEX_FILE" <<'EOF'
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>Playwright E2E Reports</title>
            </head>
            <body>
              <h1>Playwright E2E Reports</h1>
              <p>Per-shard reports:</p>
              <ul>
          EOF

          for shard_dir in playwright-artifacts-shards/playwright-artifacts-*; do
            if [ ! -d "$shard_dir" ]; then
              continue
            fi
            shard_name="$(basename "$shard_dir")"

            report_src="$shard_dir/playwright-artifacts/playwright-report"
            if [ -d "$report_src" ]; then
              mkdir -p "gh-pages/$REPORT_DIR/$shard_name"
              cp -r "$report_src/"* "gh-pages/$REPORT_DIR/$shard_name/"
              echo "                <li><a href=\"./$shard_name/\">$shard_name</a></li>" >> "$INDEX_FILE"
            fi
          done

          cat >> "$INDEX_FILE" <<'EOF'
              </ul>
            </body>
          </html>
          EOF

          # Merge shard test-results.json into a single file for PR description comparisons.
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const root = path.resolve('playwright-artifacts-shards');
          const outPath = path.resolve('gh-pages', process.env.REPORT_DIR || '', 'test-results.json');

          function walk(dir, files) {
            const entries = fs.readdirSync(dir, { withFileTypes: true });
            for (const entry of entries) {
              const full = path.join(dir, entry.name);
              if (entry.isDirectory()) {
                walk(full, files);
              } else if (
                entry.isFile() &&
                entry.name === 'test-results.json' &&
                full.includes(`${path.sep}playwright-artifacts${path.sep}`)
              ) {
                files.push(full);
              }
            }
          }

          const files = [];
          if (fs.existsSync(root)) {
            walk(root, files);
          }

          const merged = {
            stats: { expected: 0, unexpected: 0, flaky: 0, skipped: 0 },
            suites: [],
            errors: [],
          };

          for (const file of files) {
            const data = JSON.parse(fs.readFileSync(file, 'utf8'));
            const stats = data.stats || {};
            merged.stats.expected += Number(stats.expected) || 0;
            merged.stats.unexpected += Number(stats.unexpected) || 0;
            merged.stats.flaky += Number(stats.flaky) || 0;
            merged.stats.skipped += Number(stats.skipped) || 0;
            if (Array.isArray(data.suites)) merged.suites.push(...data.suites);
            if (Array.isArray(data.errors)) merged.errors.push(...data.errors);
          }

          // Ensure output directory exists.
          fs.mkdirSync(path.dirname(outPath), { recursive: true });
          fs.writeFileSync(outPath, JSON.stringify(merged, null, 2));
          console.log(`Merged ${files.length} shard result files into ${outPath}`);
          NODE
        env:
          REPORT_DIR: ${{ github.event_name == 'pull_request' && github.event.pull_request.number || 'main' }}

      - name: Deploy report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          destination_dir: .
          force_orphan: true

  update_pr:
    name: Update PR Description
    needs: [e2e_tests, bundle_size]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Playwright artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-artifacts-*
          path: playwright-artifacts-shards

      - name: Merge shard test results
        run: |
          mkdir -p playwright-artifacts
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const root = path.resolve('playwright-artifacts-shards');
          const outPath = path.resolve('playwright-artifacts', 'test-results.json');

          function walk(dir, files) {
            const entries = fs.readdirSync(dir, { withFileTypes: true });
            for (const entry of entries) {
              const full = path.join(dir, entry.name);
              if (entry.isDirectory()) {
                walk(full, files);
              } else if (
                entry.isFile() &&
                entry.name === 'test-results.json' &&
                full.includes(`${path.sep}playwright-artifacts${path.sep}`)
              ) {
                files.push(full);
              }
            }
          }

          const files = [];
          if (fs.existsSync(root)) {
            walk(root, files);
          }

          const merged = {
            stats: { expected: 0, unexpected: 0, flaky: 0, skipped: 0 },
            suites: [],
            errors: [],
          };

          for (const file of files) {
            const data = JSON.parse(fs.readFileSync(file, 'utf8'));
            const stats = data.stats || {};
            merged.stats.expected += Number(stats.expected) || 0;
            merged.stats.unexpected += Number(stats.unexpected) || 0;
            merged.stats.flaky += Number(stats.flaky) || 0;
            merged.stats.skipped += Number(stats.skipped) || 0;
            if (Array.isArray(data.suites)) merged.suites.push(...data.suites);
            if (Array.isArray(data.errors)) merged.errors.push(...data.errors);
          }

          fs.writeFileSync(outPath, JSON.stringify(merged, null, 2));
          console.log(`Merged ${files.length} shard result files into ${outPath}`);
          NODE

      - name: Fetch gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages
          mkdir gh-pages
          git --work-tree=gh-pages checkout gh-pages -- .

      - name: Update PR description
        uses: actions/github-script@v6
        env:
          CURRENT_SIZE: ${{ needs.bundle_size.outputs.current_size }}
          MAIN_SIZE: ${{ needs.bundle_size.outputs.main_size }}
          SIZE_DIFF: ${{ needs.bundle_size.outputs.diff }}
          SIZE_PERCENT: ${{ needs.bundle_size.outputs.percent }}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const updatePRDescription = require('./.github/workflows/scripts/update-pr-description.js');
            await updatePRDescription(github, context);
